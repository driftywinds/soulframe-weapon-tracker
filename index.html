<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soulframe Weapon Tracker</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@300;400;500;600;700&family=Metamorphous&display=swap" rel="stylesheet">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .grenze-font { font-family: 'Grenze Gotisch', serif; }
    .metamorphous-font { font-family: 'Metamorphous', serif; }
    input, button, th, td { font-family: 'Grenze Gotisch', serif; }
    
    /* Base font sizes */
    html { font-size: 16px; }
    @media (min-width: 768px) { html { font-size: 18px; } }
    
    /* Responsive font size classes */
    .text-table-header { font-size: 0.9rem; }
    @media (min-width: 768px) { .text-table-header { font-size: 1.2rem; } }
    
    .text-table-cell { font-size: 0.9rem; }
    @media (min-width: 768px) { .text-table-cell { font-size: 1.1rem; } }
    
    .text-category-title { font-size: 1.2rem; }
    @media (min-width: 768px) { .text-category-title { font-size: 1.8rem; } }
    
    .text-section-title { font-size: 1.5rem; }
    @media (min-width: 768px) { .text-section-title { font-size: 2.2rem; } }
    
    .text-main-title { font-size: 2rem; }
    @media (min-width: 768px) { .text-main-title { font-size: 3.5rem; } }
    
    .text-search { font-size: 1rem; }
    @media (min-width: 768px) { .text-search { font-size: 1.3rem; } }
    
    .text-button { font-size: 1rem; }
    @media (min-width: 768px) { .text-button { font-size: 1.2rem; } }
    
    .text-footer { font-size: 0.9rem; }
    @media (min-width: 768px) { .text-footer { font-size: 1.1rem; } }
    
    /* Mobile table improvements */
    .mobile-table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-left: -1rem;
      margin-right: -1rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }
    @media (min-width: 768px) {
      .mobile-table-container {
        margin-left: 0;
        margin-right: 0;
        padding-left: 0;
        padding-right: 0;
      }
    }
    
    .table-responsive { min-width: 800px; }
    @media (min-width: 768px) {
      .table-responsive { min-width: auto; width: 100%; }
    }
    
    .mobile-padding { padding-left: 1rem; padding-right: 1rem; }
    @media (min-width: 768px) {
      .mobile-padding { padding-left: 0; padding-right: 0; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- GOOGLE DRIVE CONFIGURATION ---
    // These variables will be set by the fetch operation in the useEffect hook.
    let CLIENT_ID = null;
    let API_KEY = null; 
    
    const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
    const DATA_FILE_NAME = 'soulframe_tracker_data.json';
    // ----------------------------------

    // --- ICON COMPONENTS ---
    const Check = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>
    );
    const Download = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
    );
    const Upload = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
    );
    const Github = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg>
    );
    const SearchIcon = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
    );
    const GoogleDriveIcon = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2l9 17h-9L3 2h9zM22 22H2l3.5-6h13L22 22zM8.5 22L12 16l3.5 6h-7z" stroke="currentColor" /></svg>
    );
    const CloudUpload = ({ size = 24, className = "" }) => (
       <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 12v9"></path><path d="m16 16-4-4-4 4"></path><path d="M20 12h0c0-2.21-1.79-4-4-4h0c0-3.31-2.69-6-6-6h0c-3.31 0-6 2.69-6 6h0c-2.21 0-4 1.79-4 4h0"></path></svg>
    );
    const CloudDownload = ({ size = 24, className = "" }) => (
       <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 13v8"></path><path d="m8 17 4 4 4-4"></path><path d="M20 12h0c0-2.21-1.79-4-4-4h0c0-3.31-2.69-6-6-6h0c-3.31 0-6 2.69-6 6h0c-2.21 0-4 1.79-4 4h0"></path></svg>
    );
    const SettingsIcon = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09A1.65 1.65 0 0 0 15 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    );
    // -------------------------------------

    const WeaponTracker = () => {
      const [sortConfig, setSortConfig] = useState({ key: null, direction: null });
      const [searchTerm, setSearchTerm] = useState('');
      const [isSettingsOpen, setIsSettingsOpen] = useState(false); 
      
      // Google Drive State
      const [isGapiLoaded, setIsGapiLoaded] = useState(false);
      const [isGisLoaded, setIsGisLoaded] = useState(false);
      const [isDriveConnected, setIsDriveConnected] = useState(false);
      const tokenClient = useRef(null);
      const settingsRef = useRef(null);
      const [driveStatus, setDriveStatus] = useState(''); 
      const [keysLoaded, setKeysLoaded] = useState(false); 
      const [keyError, setKeyError] = useState(false); 

      // --- 1. KEY FETCHING LOGIC ---
      useEffect(() => {
        // Fetch keys from the Cloudflare Pages Function endpoint
        async function fetchKeys() {
          try {
            // The /keys endpoint maps to the functions/keys.js file
            const response = await fetch('/keys'); 
            const data = await response.json();
            
            if (!response.ok || data.error) {
                const errorMsg = data.error || `Failed to fetch keys: ${response.statusText}`;
                console.error("Cloudflare Function Error:", errorMsg);
                setDriveStatus(`FATAL: Key configuration failed. ${errorMsg}`);
                setKeyError(true);
                return;
            }

            // Set the global variables
            CLIENT_ID = data.clientID;
            API_KEY = data.apiKey;
            setKeysLoaded(true);
            setDriveStatus('Configuration Loaded.');
            setTimeout(() => setDriveStatus(''), 3000);

          } catch (error) {
            console.error("Key Fetch Error:", error);
            setDriveStatus('FATAL: Could not load configuration. Ensure "functions/keys.js" is deployed.');
            setKeyError(true);
          }
        }
        fetchKeys();
      }, []);

      // --- 2. DYNAMIC GOOGLE SCRIPT LOADING ---
      useEffect(() => {
        if (!keysLoaded) return; // Wait for keys to load before loading Google scripts
        
        // Function to load external JS scripts dynamically
        const loadScript = (src, onloadCallback) => {
          const script = document.createElement("script");
          script.src = src;
          script.async = true;
          script.defer = true;
          script.onload = onloadCallback;
          document.head.appendChild(script);
        };

        // Load GAPI (Google Platform Library)
        loadScript("https://apis.google.com/js/api.js", () => {
          gapi.load("client", async () => {
            try {
                await gapi.client.init({
                  apiKey: API_KEY,
                  discoveryDocs: DISCOVERY_DOCS,
                });
                setIsGapiLoaded(true);
            } catch(e) {
                console.error("GAPI Initialization Failed (Check API Key restriction/origin):", e);
                setDriveStatus("GAPI init failed. Check Console and API Key.");
            }
          });
        });

        // Load GIS (Google Identity Services)
        loadScript("https://accounts.google.com/gsi/client", () => {
           setIsGisLoaded(true);
        });
      }, [keysLoaded]);


      // --- 3. Token Client Initialization ---
      useEffect(() => {
        if (isGisLoaded && CLIENT_ID) { // Ensure GIS is loaded and keys are available
          tokenClient.current = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (response) => {
              if (response.error !== undefined) {
                console.error(response);
                setDriveStatus('Error connecting to Drive. Check console for details.');
                return;
              }
              setIsDriveConnected(true);
              setDriveStatus('Connected to Google Drive (App Data).');
              setTimeout(() => setDriveStatus(''), 3000);
            },
          });
        }
      }, [isGisLoaded]);


      // --- 4. GOOGLE DRIVE INTEGRATION LOGIC ---

      const handleAuthClick = () => {
        if (keyError) {
          alert('Cannot connect: API keys failed to load. Check Cloudflare configuration.');
          return;
        }
        if (!tokenClient.current) {
            setDriveStatus('Google services are still loading. Please wait a moment.');
            return;
        }
        setIsSettingsOpen(false); 
        if (gapi.client.getToken() === null) {
          tokenClient.current.requestAccessToken({prompt: 'consent'});
        } else {
          tokenClient.current.requestAccessToken({prompt: ''});
        }
      };

      const handleSignoutClick = () => {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          setIsDriveConnected(false);
          setDriveStatus('Disconnected from Drive.');
        }
        setIsSettingsOpen(false);
        setTimeout(() => setDriveStatus(''), 3000);
      };

      const saveToDrive = async () => {
        if (!isDriveConnected) {
            setDriveStatus('Please connect to Google Drive first.');
            return;
        }
        setDriveStatus('Saving...');
        setIsSettingsOpen(false); 
        try {
          const response = await gapi.client.drive.files.list({
            q: `name = '${DATA_FILE_NAME}' and 'appDataFolder' in parents and trashed = false`,
            fields: 'files(id, name)',
            spaces: 'appDataFolder'
          });

          const fileContent = JSON.stringify(weaponData);
          const file = new Blob([fileContent], {type: 'application/json'});
          const metadata = {
            name: DATA_FILE_NAME,
            mimeType: 'application/json',
            parents: ['appDataFolder']
          };

          const accessToken = gapi.auth.getToken().access_token;
          const form = new FormData();
          form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          form.append('file', file);

          if (response.result.files && response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            const updateUrl = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
            
            await fetch(updateUrl, {
              method: 'PATCH',
              headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
              body: form
            });
            setDriveStatus('Progress saved to Drive!');
          } else {
            const createUrl = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            await fetch(createUrl, {
              method: 'POST',
              headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
              body: form
            });
            setDriveStatus('Backup created on Drive!');
          }
        } catch (err) {
          console.error(err);
          setDriveStatus('Error saving to Drive. See console.');
        }
        setTimeout(() => setDriveStatus(''), 3000);
      };

      const loadFromDrive = async () => {
        if (!isDriveConnected) {
            setDriveStatus('Please connect to Google Drive first.');
            return;
        }
        setDriveStatus('Loading...');
        setIsSettingsOpen(false); 
        try {
          const response = await gapi.client.drive.files.list({
            q: `name = '${DATA_FILE_NAME}' and 'appDataFolder' in parents and trashed = false`,
            fields: 'files(id, name)',
            spaces: 'appDataFolder'
          });

          if (response.result.files && response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            const fileResponse = await gapi.client.drive.files.get({
              fileId: fileId,
              alt: 'media'
            });
            
            // Note: fileResponse.result is the JSON object (the file content)
            setWeaponData(fileResponse.result); 
            setDriveStatus('Progress loaded from Drive!');
          } else {
            setDriveStatus('No backup found on Drive. Use "Save Progress" to create one.');
          }
        } catch (err) {
          console.error(err);
          setDriveStatus('Error loading from Drive. See console.');
        }
        setTimeout(() => setDriveStatus(''), 3000);
      };

      // -------------------------------------


      // Close settings when clicking outside
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (settingsRef.current && !settingsRef.current.contains(event.target)) {
            setIsSettingsOpen(false);
          }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
      }, [settingsRef]);

      // Attunement icon mapping
      const attunementIcons = {
        'Courage': 'https://static.wikitide.net/soulframewiki/thumb/c/ca/CouragePip.png/100px-CouragePip.png',
        'Spirit': 'https://static.wikitide.net/soulframewiki/thumb/3/38/SpiritPip.png/100px-SpiritPip.png',
        'Grace': 'https://static.wikitide.net/soulframewiki/thumb/f/ff/GracePip.png/100px-GracePip.png'
      };

      const getImagePath = (category, weaponName, isSidearm) => {
        // ... (getImagePath function remains the same)
        const categoryMap = {
          'BOW': 'bow',
          'GREATSWORD': 'greatsword',
          'LONG BLADE': 'longblade',
          'MAGICK': isSidearm ? 'magick_s' : 'magick',
          'POLEARM': 'polearm',
          'SHIELD': 'shield',
          'SHORT BLADE': isSidearm ? 'shortblade_s' : 'shortblade',
          'FLYBLADE': 'flyblade'
        };
        const folder = categoryMap[category] || category.toLowerCase().replace(' ', '');
        const fileName = weaponName.replace(/[']/g, '').replace(/\s+/g, '');
        return `assets/weapons/${folder}/${fileName}.png`;
      };

      const renderAttunement = (attunementString) => {
        // ... (renderAttunement function remains the same)
        if (!attunementString) return '-';
        const attunements = attunementString.split(',').map(a => a.trim());
        return (
          <div className="flex items-center justify-center gap-1 flex-wrap">
            {attunements.map((attunement, index) => (
              <div key={index} className="flex items-center gap-1">
                {attunementIcons[attunement] && (
                  <img src={attunementIcons[attunement]} alt={attunement} className="w-6 h-6 md:w-7 md:h-7 inline-block" title={attunement} />
                )}
                <span className="text-sm md:text-base text-gray-300 grenze-font">{attunement}</span>
              </div>
            ))}
          </div>
        );
      };

      const handleSort = (key, category) => {
        // ... (handleSort function remains the same)
        let direction = 'asc';
        if (sortConfig.key === `${category}-${key}` && sortConfig.direction === 'asc') {
          direction = 'desc';
        }
        setSortConfig({ key: `${category}-${key}`, direction });
      };

      const sortWeapons = (categoryWeapons, category) => {
        // ... (sortWeapons function remains the same)
        if (!sortConfig.key || !sortConfig.key.startsWith(`${category}-`)) {
          return categoryWeapons;
        }
        const key = sortConfig.key.replace(`${category}-`, '');
        const sorted = [...categoryWeapons].sort((a, b) => {
          let aValue, bValue;
          if (key === 'smite') {
            aValue = parseInt(a.smite) || 0;
            bValue = parseInt(b.smite) || 0;
          } else if (key === 'virtueCap') {
            aValue = parseInt(a.virtueCap) || 0;
            bValue = parseInt(b.virtueCap) || 0;
          } else if (key === 'level') {
            aValue = parseInt(weaponData[a.name]?.level) || 0;
            bValue = parseInt(weaponData[b.name]?.level) || 0;
          } else if (key === 'tier') {
            aValue = parseInt(a.tier?.replace('Tier ', '')) || 0;
            bValue = parseInt(b.tier?.replace('Tier ', '')) || 0;
          }
          if (sortConfig.direction === 'asc') return aValue - bValue;
          return bValue - aValue;
        });
        return sorted;
      };

      const weapons = [
        // ... (weapons array remains the same)
        { category: 'BOW', name: 'Blitzel', attunement: 'Courage', tier: 'Tier 2', smite: '2', virtueCap: '28' },
        { category: 'BOW', name: 'Juniper', attunement: 'Grace', tier: 'Tier 2', smite: '6', virtueCap: '29' },
        { category: 'BOW', name: 'The Starling', attunement: 'Grace', tier: 'Tier 2', smite: '4', virtueCap: '30' },
        { category: 'BOW', name: 'Thistle', attunement: 'Grace', tier: 'Tier 1', smite: '5', virtueCap: '36' },
        { category: 'GREATSWORD', name: 'Needleseye', attunement: 'Courage', tier: 'Tier 2', smite: '5', virtueCap: '43' },
        { category: 'GREATSWORD', name: 'Purity', attunement: 'Courage', tier: 'Tier 3', smite: '6', virtueCap: '36' },
        { category: 'GREATSWORD', name: 'The Paragon', attunement: 'Courage, Spirit, Grace', tier: 'Tier 3', smite: '7', virtueCap: '114+' },
        { category: 'LONG BLADE', name: 'Dewelion', attunement: 'Grace', tier: 'Tier 3', smite: '6', virtueCap: '22' },
        { category: 'LONG BLADE', name: 'Igne Mora', attunement: 'Courage', tier: 'Tier 2', smite: '1', virtueCap: '29' },
        { category: 'LONG BLADE', name: "Marrow's Bane", attunement: 'Courage', tier: 'Tier 3', smite: '5', virtueCap: '27' },
        { category: 'LONG BLADE', name: 'Nurash', attunement: 'Courage', tier: 'Tier 2', smite: '5', virtueCap: '26' },
        { category: 'LONG BLADE', name: 'Sollos-I', attunement: 'Spirit', tier: 'Tier 2', smite: '4', virtueCap: '27' },
        { category: 'LONG BLADE', name: 'Stultin', attunement: 'Grace', tier: 'Tier 2', smite: '3', virtueCap: '33' },
        { category: 'LONG BLADE', name: 'Tessard', attunement: 'Spirit', tier: 'Tier 2', smite: '2', virtueCap: '25' },
        { category: 'LONG BLADE', name: 'The Ivor', attunement: 'Courage', tier: 'Tier 2', smite: '4', virtueCap: '29' },
        { category: 'LONG BLADE', name: 'Vetch', attunement: 'Courage', tier: 'Tier 2', smite: '3', virtueCap: '28' },
        { category: 'LONG BLADE', name: 'Wulder', attunement: 'Courage', tier: 'Tier 1', smite: '3', virtueCap: '36' },
        { category: 'MAGICK', name: 'Gwylen', attunement: 'Spirit', tier: 'Tier 1', smite: '6', virtueCap: '32' },
        { category: 'MAGICK', name: 'The Alder', attunement: 'Spirit', tier: 'Tier 2', smite: '6', virtueCap: '27' },
        { category: 'MAGICK', name: 'The Erstroot', attunement: 'Spirit', tier: 'Tier 2', smite: '6', virtueCap: '27' },
        { category: 'POLEARM', name: 'Duhk Halic', attunement: 'Courage', tier: 'Tier 2', smite: '4', virtueCap: '39' },
        { category: 'POLEARM', name: 'Gathannan', attunement: 'Spirit', tier: 'Tier 3', smite: '4', virtueCap: '35' },
        { category: 'POLEARM', name: 'Rook', attunement: 'Spirit', tier: 'Tier 2', smite: '2', virtueCap: '40' },
        { category: 'POLEARM', name: 'Vasp-IV', attunement: 'Courage', tier: 'Tier 1', smite: '5', virtueCap: '58' },
        { category: 'SHIELD', name: 'Bog & Myrtle', attunement: 'Grace', tier: 'Tier 2', smite: '2', virtueCap: '26' },
        { category: 'SHIELD', name: 'Oryn-Umbr', attunement: 'Courage', tier: 'Tier 2', smite: '5', virtueCap: '25' },
        { category: 'SHORT BLADE', name: 'Rivt-II', attunement: 'Grace', tier: 'Tier 1', smite: '4', virtueCap: '26' },
        { category: 'SHORT BLADE', name: 'The Royal Tines', attunement: 'Spirit', tier: 'Tier 2', smite: '6', virtueCap: '17' },
        { category: 'SHORT BLADE', name: 'Unsula', attunement: 'Spirit', tier: 'Tier 2', smite: '5', virtueCap: '17' },
        { category: 'FLYBLADE', name: 'Precklies', attunement: 'Courage', tier: 'Tier 1', smite: '4', virtueCap: '25', isSidearm: true },
        { category: 'FLYBLADE', name: 'Skilter', attunement: 'Grace', tier: 'Tier 2', smite: '3', virtueCap: '19', isSidearm: true },
        { category: 'FLYBLADE', name: 'Thrice Spurns', attunement: 'Courage', tier: 'Tier 2', smite: '4', virtueCap: '21', isSidearm: true },
        { category: 'MAGICK', name: 'Esthelle', attunement: 'Spirit', tier: 'Tier 2', smite: '9', virtueCap: '22', isSidearm: true },
        { category: 'MAGICK', name: 'Odiac', attunement: 'Spirit', tier: 'Tier 2', smite: '6', virtueCap: '21', isSidearm: true },
        { category: 'SHORT BLADE', name: 'Cobladh', attunement: 'Grace', tier: 'Tier 2', smite: '4', virtueCap: '26', isSidearm: true },
        { category: 'SHORT BLADE', name: 'Grinn', attunement: 'Courage', tier: 'Tier 2', smite: '6', virtueCap: '23', isSidearm: true },
        { category: 'SHORT BLADE', name: 'Nettle', attunement: 'Grace', tier: 'Tier 1', smite: '3', virtueCap: '32', isSidearm: true },
        { category: 'SHORT BLADE', name: 'Virdigris', attunement: 'Spirit', tier: 'Tier 2', smite: '4', virtueCap: '24', isSidearm: true },
        { category: 'SHORT BLADE', name: 'Witan', attunement: 'Courage', tier: 'Tier 2', smite: '5', virtueCap: '23', isSidearm: true },
      ];

      // Local storage persistence via cookie
      const [weaponData, setWeaponData] = useState(() => {
        const saved = document.cookie.split('; ').find(row => row.startsWith('weaponData='));
        if (saved) {
          try { return JSON.parse(decodeURIComponent(saved.split('=')[1])); } catch (e) { return {}; }
        }
        return {};
      });

      useEffect(() => {
        const expires = new Date();
        expires.setFullYear(expires.getFullYear() + 1);
        document.cookie = `weaponData=${encodeURIComponent(JSON.stringify(weaponData))}; expires=${expires.toUTCString()}; path=/`;
      }, [weaponData]);

      const toggleOwned = (weaponName) => {
        setWeaponData(prev => ({ ...prev, [weaponName]: { ...prev[weaponName], owned: !prev[weaponName]?.owned } }));
      };

      const updateLevel = (weaponName, level) => {
        let validLevel = level;
        if (level !== '') {
          const numLevel = parseInt(level, 10);
          if (numLevel > 30) validLevel = '30';
          if (numLevel < 0) validLevel = '0';
        }
        setWeaponData(prev => ({ ...prev, [weaponName]: { ...prev[weaponName], level: validLevel } }));
      };

      const exportData = () => {
        // Local export logic
        const dataStr = JSON.stringify(weaponData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `soulframe-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        setIsSettingsOpen(false); 
      };

      const importData = (event) => {
        // Local import logic
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            setWeaponData(imported);
            alert('Data imported successfully!');
          } catch (error) {
            alert('Error importing data. Please ensure the file is a valid backup file.');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
        setIsSettingsOpen(false); 
      };

      const filteredWeapons = weapons.filter(weapon => 
        weapon.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        weapon.category.toLowerCase().includes(searchTerm.toLowerCase()) ||
        weapon.attunement.toLowerCase().includes(searchTerm.toLowerCase()) ||
        weapon.tier.toLowerCase().includes(searchTerm.toLowerCase())
      );

      const groupedWeapons = filteredWeapons.reduce((acc, weapon) => {
        const section = weapon.isSidearm ? 'SIDEARMS' : 'WEAPONS';
        if (!acc[section]) acc[section] = {};
        if (!acc[section][weapon.category]) acc[section][weapon.category] = [];
        acc[section][weapon.category].push(weapon);
        return acc;
      }, {});

      // --- Settings Dropdown Component (New UI) ---
      const SettingsDropdown = () => {
        const commonButtonClasses = "flex items-center gap-3 w-full px-4 py-2 text-left grenze-font text-button hover:bg-gray-600 transition-colors";
        
        // Determine if Google Drive actions should be enabled
        const isDriveReady = keysLoaded && isGapiLoaded && isGisLoaded && !keyError;

        return (
          <div ref={settingsRef} className="absolute right-0 top-0">
            <button 
              onClick={() => setIsSettingsOpen(prev => !prev)} 
              className="p-2 md:p-3 rounded-full text-amber-400 hover:bg-gray-800 transition-colors"
              aria-expanded={isSettingsOpen}
              aria-label="Settings"
            >
              <SettingsIcon size={24} className="md:w-7 md:h-7" />
            </button>
            
            {isSettingsOpen && (
              <div className="absolute right-0 mt-2 w-72 md:w-80 bg-gray-700 border border-gray-600 rounded-lg shadow-2xl z-50 overflow-hidden">
                <div className="p-3 border-b border-gray-600">
                  <p className="text-amber-400 font-bold grenze-font text-xl">Data Management</p>
                </div>
                
                {/* Local Backup Options */}
                <div className="py-1">
                  <p className="px-4 py-2 text-sm text-gray-400 grenze-font">Local Storage (Browser)</p>
                  <button onClick={exportData} className={`${commonButtonClasses} text-amber-300`}>
                    <Download size={20} /> Export to File
                  </button>
                  <label className={`${commonButtonClasses} text-blue-300 cursor-pointer`}>
                    <Upload size={20} /> Import from File
                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                  </label>
                </div>

                {/* Google Drive Options */}
                <div className="py-1 border-t border-gray-600">
                  <p className="px-4 py-2 text-sm text-gray-400 grenze-font">Google Drive (App Data)</p>
                  {!isDriveReady && !keyError && (
                     <p className="px-4 py-2 text-sm text-gray-400 grenze-font animate-pulse">Loading Google services...</p>
                  )}
                  {keyError && (
                     <p className="px-4 py-2 text-sm text-red-400 grenze-font">Configuration Error. See status below.</p>
                  )}
                  
                  {isDriveReady && !isDriveConnected ? (
                    <button onClick={handleAuthClick} className={`${commonButtonClasses} text-green-400`}>
                      <GoogleDriveIcon size={20} /> Connect to Drive
                    </button>
                  ) : isDriveReady && (
                    <>
                      <button onClick={saveToDrive} className={`${commonButtonClasses} text-teal-300`}>
                        <CloudUpload size={20} /> Save Progress
                      </button>
                      <button onClick={loadFromDrive} className={`${commonButtonClasses} text-cyan-300`}>
                        <CloudDownload size={20} /> Load Progress
                      </button>
                      <button onClick={handleSignoutClick} className={`${commonButtonClasses} text-red-400`}>
                        <GoogleDriveIcon size={20} /> Disconnect Drive
                      </button>
                    </>
                  )}
                </div>
              </div>
            )}
          </div>
        );
      };
      // --- End Settings Dropdown Component ---


      const renderWeaponTable = (categoryWeapons, category) => (
        <div key={category} className="mb-8">
          <h2 className="font-bold text-amber-400 mb-4 border-b-2 border-amber-600 pb-2 metamorphous-font text-category-title">{category}</h2>
          <div className="mobile-table-container">
            <table className="w-full border-collapse bg-gray-800 shadow-lg table-responsive">
              <thead>
                <tr className="bg-gray-700">
                  <th className="border border-gray-600 p-2 md:p-3 text-center text-amber-300 grenze-font text-table-header" style={{width: '100px'}}>Image</th>
                  <th className="border border-gray-600 p-2 md:p-3 text-center text-amber-300 grenze-font text-table-header" style={{width: '150px'}}>Weapon Name</th>
                  <th className="border border-gray-600 p-2 md:p-3 text-center text-amber-300 grenze-font text-table-header" style={{width: '200px'}}>Attunement</th>
                  <th className="border border-gray-600 p-2 md:p-3 text-center text-amber-300 cursor-pointer hover:bg-gray-600 transition-colors select-none grenze-font text-table-header" style={{width: '80px'}} onClick={() => handleSort('tier', category)}>
                    <div className="flex items-center justify-center gap-1">Tier {sortConfig.key === `${category}-tier` && (<span className="text-xs md:text-base">{sortConfig.direction === 'asc' ? '↑' : '↓'}</span>)}</div>
                  </th>
                  <th className="border border-gray-600 p-2 md:p-3 text-center text-amber-300 cursor-pointer hover:bg-gray-600 transition-colors select-none grenze-font text-table-header" style={{width: '70px'}} onClick={() => handleSort('smite', category)}>
                    <div className="flex items-center justify-center gap-1">Smite % {sortConfig.key === `${category}-smite` && (<span className="text-xs md:text-base">{sortConfig.direction === 'asc' ? '↑' : '↓'}</span>)}</div>
                  </th>
                  <th className="border border-gray-600 p-2 md:p-3 text-center text-amber-300 cursor-pointer hover:bg-gray-600 transition-colors select-none grenze-font text-table-header" style={{width: '100px'}} onClick={() => handleSort('virtueCap', category)}>
                    <div className="flex items-center justify-center gap-1">Virtue Cap {sortConfig.key === `${category}-virtueCap` && (<span className="text-xs md:text-base">{sortConfig.direction === 'asc' ? '↑' : '↓'}</span>)}</div>
                  </th>
                  <th className="border border-gray-600 p-2 md:p-3 text-center text-amber-300 grenze-font text-table-header" style={{width: '80px'}}>Owned</th>
                  <th className="border border-gray-600 p-2 md:p-3 text-center text-amber-300 cursor-pointer hover:bg-gray-600 transition-colors select-none grenze-font text-table-header" style={{width: '80px'}} onClick={() => handleSort('level', category)}>
                    <div className="flex items-center justify-center gap-1">Level {sortConfig.key === `${category}-level` && (<span className="text-xs md:text-base">{sortConfig.direction === 'asc' ? '↑' : '↓'}</span>)}</div>
                  </th>
                </tr>
              </thead>
              <tbody>
                {sortWeapons(categoryWeapons, category).map((weapon) => (
                  <tr key={weapon.name} className="hover:bg-gray-700 transition-colors">
                    <td className="border border-gray-600 p-1 md:p-2" style={{width: '100px'}}>
                      <img src={getImagePath(weapon.category, weapon.name, weapon.isSidearm)} alt={weapon.name} className="w-14 h-14 md:w-20 md:h-20 object-contain rounded mx-auto" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; }} />
                      <div className="w-14 h-14 md:w-20 md:h-20 bg-gray-700 rounded flex items-center justify-center text-gray-500 text-xs md:text-base mx-auto" style={{display: 'none'}}>No Image</div>
                    </td>
                    <td className="border border-gray-600 p-2 md:p-3 text-gray-200 font-medium text-center grenze-font text-table-cell" style={{width: '150px'}}>{weapon.name}</td>
                    <td className="border border-gray-600 p-2 md:p-3" style={{width: '200px'}}>{renderAttunement(weapon.attunement)}</td>
                    <td className="border border-gray-600 p-2 md:p-3 text-gray-300 text-center grenze-font text-table-cell" style={{width: '80px'}}>{weapon.tier || '-'}</td>
                    <td className="border border-gray-600 p-2 md:p-3 text-gray-300 text-center grenze-font text-table-cell" style={{width: '70px'}}>{weapon.smite || '-'}</td>
                    <td className="border border-gray-600 p-2 md:p-3 text-gray-300 text-center grenze-font text-table-cell" style={{width: '100px'}}>{weapon.virtueCap || '-'}</td>
                    <td className="border border-gray-600 p-2 md:p-3 text-center" style={{width: '80px'}}>
                      <button onClick={() => toggleOwned(weapon.name)} className={`w-8 h-8 md:w-10 md:h-10 rounded flex items-center justify-center transition-colors mx-auto ${weaponData[weapon.name]?.owned ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-500'}`}>
                        {weaponData[weapon.name]?.owned && <Check size={20} className="text-white" />}
                      </button>
                    </td>
                    <td className="border border-gray-600 p-2 md:p-3" style={{width: '80px'}}>
                      <input type="number" min="0" max="30" value={weaponData[weapon.name]?.level || ''} onChange={(e) => updateLevel(weapon.name, e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded px-1 md:px-2 py-1 md:py-2 text-gray-200 text-center focus:outline-none focus:border-amber-500 grenze-font text-table-cell" placeholder="0" />
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );

      return (
        <div className="min-h-screen bg-gray-900 p-4 md:p-6 flex flex-col">
          <div className="max-w-7xl mx-auto flex-grow w-full mobile-padding">
            
            {/* HEADER LAYOUT: Title and Settings Icon */}
            <div className="relative flex justify-center items-center mb-6 md:mb-8">
              <h1 className="font-bold text-amber-400 text-center border-b-2 md:border-b-4 border-amber-600 pb-3 md:pb-4 metamorphous-font text-main-title">
                Soulframe Weapon Tracker (P12)
              </h1>
              <SettingsDropdown />
            </div>

            {/* Drive Status/Key Status below the title */}
            {driveStatus && (
              <p className={`text-sm grenze-font animate-pulse text-center mb-4 ${keyError ? 'text-red-400' : 'text-amber-300'}`}>{driveStatus}</p>
            )}

            {/* Search Bar */}
            <div className="mb-6 md:mb-8 relative">
              <div className="relative max-w-2xl mx-auto">
                <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search weapons..." className="w-full bg-gray-800 border-2 border-amber-600 rounded-lg px-4 py-2 md:py-3 pl-10 md:pl-12 text-gray-200 focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/30 grenze-font text-search" />
                <div className="absolute left-3 md:left-4 top-1/2 transform -translate-y-1/2 text-amber-400"><SearchIcon size={20} className="md:w-6 md:h-6" /></div>
                {searchTerm && (<button onClick={() => setSearchTerm('')} className="absolute right-3 md:right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-300 text-lg">✕</button>)}
              </div>
              {searchTerm && (<p className="text-gray-400 text-center mt-2 grenze-font text-sm md:text-base">Showing {filteredWeapons.length} weapon{filteredWeapons.length !== 1 ? 's' : ''} matching "{searchTerm}"</p>)}
            </div>

            {/* Weapon Tables */}
            <div className="mb-8 md:mb-12">
              <h2 className="font-bold text-amber-300 mb-4 md:mb-6 metamorphous-font text-section-title">WEAPONS</h2>
              {Object.entries(groupedWeapons.WEAPONS || {}).map(([category, categoryWeapons]) => renderWeaponTable(categoryWeapons, category))}
            </div>

            <div>
              <h2 className="font-bold text-amber-300 mb-4 md:mb-6 metamorphous-font text-section-title">SIDEARMS</h2>
              {Object.entries(groupedWeapons.SIDEARMS || {}).map(([category, categoryWeapons]) => renderWeaponTable(categoryWeapons, category))}
            </div>
          </div>

          <footer className="mt-8 md:mt-12 pt-6 md:pt-8 border-t border-gray-700">
            <div className="max-w-7xl mx-auto text-center mobile-padding">
              <p className="text-gray-400 mb-3 grenze-font text-footer">Soulframe Weapon Tracker - Track your weapon collection and progress</p>
              <div className="flex flex-col md:flex-row justify-center items-center gap-3 md:gap-6 text-gray-500 grenze-font text-sm md:text-footer">
                <a href="https://github.com/driftywinds/soulframe-weapon-tracker" target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 hover:text-amber-400 transition-colors"><Github size={16} className="md:w-5 md:h-5" /> GitHub Repository</a>
                <span className="hidden md:inline">•</span><span>All data stored on your browser by default</span><span className="hidden md:inline">•</span>
                <a href="https://wiki.avakot.org/" target="_blank" rel="noopener noreferrer" className="hover:text-amber-400 transition-colors">All information sourced from Avakot.org Soulframe Wiki</a>
              </div>
              <p className="text-gray-600 mt-3 grenze-font text-xs md:text-footer">Images and game content © Digital Extremes. This is an unofficial fan-made tracker.</p>
            </div>
          </footer>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<WeaponTracker />);
  </script>
</body>

</html>
